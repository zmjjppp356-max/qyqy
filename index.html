<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase 图片上传示例</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 50px auto; padding: 20px; text-align: center; border: 1px solid #ddd; border-radius: 8px; }
        .preview { max-width: 100%; margin-top: 20px; display: none; border-radius: 5px; }
        #status { margin-top: 10px; color: #666; }
        button { background: #3ecf8e; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>

    <h2>上传图片到 Supabase</h2>
    <input type="file" id="fileInput" accept="image/*">
    <button id="uploadBtn">点击上传</button>
    
    <p id="status"></p>
    <img id="imagePreview" class="preview" alt="上传成功的图片">

    <script>
        // 1. 初始化 Supabase (请替换为你自己的凭据)
        const SUPABASE_URL = 'https://owxqydcogmvcbgxkanzr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93eHF5ZGNvZ212Y2JneGthbnpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNDExOTksImV4cCI6MjA4MTcxNzE5OX0.me4eEqQ4NG1c2U1IX10efYmzisLU2Ls0unl-RgiRDaE';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const status = document.getElementById('status');
        const preview = document.getElementById('imagePreview');

        uploadBtn.addEventListener('click', async () => {
            const file = fileInput.files[0];
            if (!file) {
                alert('请先选择一个文件！');
                return;
            }

            uploadBtn.disabled = true;
            status.innerText = '正在上传...';

            // 2. 生成唯一文件名 (避免同名覆盖)
            const fileExt = file.name.split('.').pop();
            const fileName = `${Math.random()}.${fileExt}`;
            const filePath = `uploads/${fileName}`;

            // 3. 执行上传 (假设 Bucket 名字叫 "images")
            const { data, error } = await _supabase.storage
                .from('images') // 这里的 'images' 是你在 Supabase 后台创建的 Bucket 名字
                .upload(filePath, file);

            if (error) {
                status.innerText = '错误: ' + error.message;
            } else {
                // 4. 获取公开访问链接 (前提是 Bucket 设为 Public)
                const { data: publicUrlData } = _supabase.storage
                    .from('images')
                    .getPublicUrl(filePath);

                status.innerText = '上传成功！';
                preview.src = publicUrlData.publicUrl;
                preview.style.display = 'block';
            }
            uploadBtn.disabled = false;
        });
    </script>
    <div id="imageContainer">
    <img id="imagePreview" style="display:none; width: 200px;">
    <button id="deleteBtn" style="display:none; background: red; color: white;">删除这张图片</button>
    </div>

    <script>
        let currentFilePath = ''; // 用于记录当前上传的文件路径

        // 在你之前的上传成功逻辑里赋值
        // ... upload 成功后 ...
        currentFilePath = data.path; // 保存路径供删除使用
        document.getElementById('deleteBtn').style.display = 'block';

        // 删除按钮点击事件
        document.getElementById('deleteBtn').addEventListener('click', async () => {
            if (!currentFilePath) return;
        
            const { data, error } = await supabaseClient
                .storage
                .from('images')
                .remove([currentFilePath]);

            if (!error) {
                alert('删除成功');
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('deleteBtn').style.display = 'none';
            }
        });
    </script>
</body>
</html>


