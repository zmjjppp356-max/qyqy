<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase å›¾ç‰‡åº“ç®¡ç†</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 600px; margin: 40px auto; padding: 20px; background-color: #f9f9f9; }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.05); }
        h2 { text-align: center; color: #333; }

        /* ä¸Šä¼ åŒºåŸŸ */
        .controls { display: flex; gap: 10px; margin-bottom: 10px; }
        input[type="file"] { flex: 1; border: 1px solid #ddd; padding: 10px; border-radius: 8px; }
        button#uploadBtn { background: #3ecf8e; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        #status { text-align: center; color: #666; font-size: 14px; min-height: 20px; margin-bottom: 20px; }

        /* å›¾ç‰‡ç½‘æ ¼å¸ƒå±€ */
        .gallery-title { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 30px; font-weight: bold; color: #444; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; margin-top: 15px; }
        
        /* å•ä¸ªå›¾ç‰‡å®¹å™¨ */
        .gallery-item { position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); group: hover; }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; cursor: zoom-in; }
        .gallery-item:hover img { transform: scale(1.05); }

        /* åˆ é™¤å°æŒ‰é’® (é»˜è®¤éšè—ï¼Œé¼ æ ‡æ‚¬åœæ˜¾ç¤º) */
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 77, 79, 0.9);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex; /* æ”¹ä¸º flex æ–¹ä¾¿å±…ä¸­ */
            align-items: center;
            justify-content: center;
            font-size: 16px;
            line-height: 1;
            z-index: 10;
            opacity: 0; /* é»˜è®¤é€æ˜ */
            transition: opacity 0.2s;
        }
        
        /* é¼ æ ‡ç§»ä¸Šå»æ—¶æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
        .gallery-item:hover .delete-btn { opacity: 1; }

        /* ç§»åŠ¨ç«¯ç›´æ¥æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
        @media (max-width: 600px) {
            .delete-btn { opacity: 1; background: rgba(255, 77, 79, 0.8); }
        }
    </style>
</head>
<body>

    <div class="card">
        <h2>ğŸ“· äº‘ç«¯ç›¸å†Œç®¡ç†</h2>
        
        <div class="controls">
            <input type="file" id="fileInput" accept="image/*">
            <button id="uploadBtn">ä¸Šä¼ </button>
        </div>
        <p id="status">å‡†å¤‡å°±ç»ª</p>

        <div class="gallery-title">ğŸ“‚ å†å²å›¾ç‰‡ (é¼ æ ‡æ‚¬åœå¯åˆ é™¤)</div>
        <div id="galleryGrid" class="gallery-grid">
            <p style="color:#ccc; font-size:12px;">åŠ è½½ä¸­...</p>
        </div>
    </div>

    <script>
        // --- 1. åˆå§‹åŒ– (è¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ Key) ---
        const SUPABASE_URL = "https://owxqydcogmvcbgxkanzr.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93eHF5ZGNvZ212Y2JneGthbnpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNDExOTksImV4cCI6MjA4MTcxNzE5OX0.me4eEqQ4NG1c2U1IX10efYmzisLU2Ls0unl-RgiRDaE";

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const statusText = document.getElementById('status');
        const galleryGrid = document.getElementById('galleryGrid');

        // --- 2. æ ¸å¿ƒåŠŸèƒ½ï¼šåŠ è½½å¹¶æ¸²æŸ“å›¾ç‰‡åˆ—è¡¨ ---
        async function loadGallery() {
            // åˆ—å‡º uploads æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶
            const { data, error } = await supabaseClient
                .storage
                .from('images') // ç¡®è®¤ Bucket åå­—
                .list('uploads', {
                    limit: 100,
                    offset: 0,
                    sortBy: { column: 'created_at', order: 'desc' },
                });

            if (error) {
                console.error("åŠ è½½å¤±è´¥:", error);
                statusText.innerText = "åŠ è½½å†å²è®°å½•å¤±è´¥";
                return;
            }

            galleryGrid.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹

            if (!data || data.length === 0) {
                galleryGrid.innerHTML = '<p style="color:#ccc; padding:20px;">æš‚æ— å›¾ç‰‡</p>';
                return;
            }

            // éå†æ¯ä¸ªæ–‡ä»¶ï¼Œç”Ÿæˆ HTML
            data.forEach(file => {
                if (file.name === '.emptyFolderPlaceholder') return; // è·³è¿‡å ä½æ–‡ä»¶

                const fullPath = `uploads/${file.name}`;
                // è·å–å›¾ç‰‡é“¾æ¥
                const { data: urlData } = supabaseClient.storage.from('images').getPublicUrl(fullPath);

                // åˆ›å»ºå®¹å™¨
                const div = document.createElement('div');
                div.className = 'gallery-item';

                // 1. å›¾ç‰‡å…ƒç´ 
                const img = document.createElement('img');
                img.src = urlData.publicUrl;
                img.onclick = () => window.open(urlData.publicUrl); // ç‚¹å‡»æŸ¥çœ‹å¤§å›¾
                
                // 2. åˆ é™¤æŒ‰é’®å…ƒç´ 
                const delBtn = document.createElement('button');
                delBtn.className = 'delete-btn';
                delBtn.innerHTML = '&times;'; // Ã— ç¬¦å·
                delBtn.title = 'åˆ é™¤è¿™å¼ å›¾ç‰‡';
                
                // 3. ç»‘å®šåˆ é™¤äº‹ä»¶
                delBtn.onclick = (e) => {
                    e.stopPropagation(); // é˜²æ­¢è§¦å‘å›¾ç‰‡çš„ç‚¹å‡»äº‹ä»¶
                    deleteSingleImage(fullPath); // è°ƒç”¨åˆ é™¤å‡½æ•°
                };

                // ç»„è£…
                div.appendChild(img);
                div.appendChild(delBtn);
                galleryGrid.appendChild(div);
            });
        }

        // --- 3. åˆ é™¤å•ä¸ªå›¾ç‰‡çš„é€»è¾‘ ---
        async function deleteSingleImage(filePath) {
            if (!confirm('ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) return;

            statusText.innerText = 'æ­£åœ¨åˆ é™¤...';
            
            const { data, error } = await supabaseClient.storage
                .from('images')
                .remove([filePath]);

            if (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
                statusText.innerText = 'åˆ é™¤å¤±è´¥';
            } else {
                statusText.innerText = 'åˆ é™¤æˆåŠŸï¼';
                loadGallery(); // é‡æ–°åŠ è½½åˆ—è¡¨ï¼Œæ›´æ–°ç•Œé¢
            }
        }

        // --- 4. ä¸Šä¼ åŠŸèƒ½ ---
        uploadBtn.addEventListener('click', async () => {
            const file = fileInput.files[0];
            if (!file) { alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶'); return; }

            uploadBtn.disabled = true;
            statusText.innerText = 'æ­£åœ¨ä¸Šä¼ ...';

            // é‡å‘½åé˜²æ­¢ä¸­æ–‡æŠ¥é”™
            const fileExt = file.name.split('.').pop();
            const fileName = `${Date.now()}-${Math.floor(Math.random() * 1000)}.${fileExt}`;
            const filePath = `uploads/${fileName}`;

            const { error } = await supabaseClient.storage
                .from('images')
                .upload(filePath, file);

            if (error) {
                statusText.innerText = 'ä¸Šä¼ å¤±è´¥: ' + error.message;
            } else {
                statusText.innerText = 'ä¸Šä¼ æˆåŠŸï¼';
                fileInput.value = ''; // æ¸…ç©ºé€‰æ‹©æ¡†
                loadGallery(); // åˆ·æ–°åˆ—è¡¨æ˜¾ç¤ºæ–°å›¾ç‰‡
            }
            uploadBtn.disabled = false;
        });

        // é¡µé¢å¯åŠ¨æ—¶åŠ è½½
        loadGallery();

    </script>
</body>
</html>
